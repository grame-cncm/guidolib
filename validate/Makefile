#
# Makefile for testing the guido engine
#
# Checking the engine output
#   the principle is the following:
#   an image target generates image files using guido2image for a large set of gmn files
#   the validate target makes the comparison of files generated by different versions
#
# Checking memory leaks
#   requires valgrind
#

version	:= $(shell guidogetversion | cut -d' ' -f 3)
system	:= $(shell uname -s)
LEAKTOOLS = guidoparse guidoar2gr guidodraw

ifeq ($(system), Darwin)
  lib =  -F../cmake/Release/ -framework GUIDOEngine
else
ifeq ($(system), MINGW32_NT-6.1)
  lib =  ../cmake/Release/GUIDOEngine.lib
  LEAKTOOLS = GUIDOEngine.dll guidogetversion.exe guido2svg.exe guidoparse.exe guidoar2gr.exe guidodraw.exe guido2image.exe
else
  lib = -lGUIDOEngine
endif
endif

guido2image := ../Qt/bin/guido2image
guido2svg   := ../tools/guido2svg
guido2midi  := ../tools/guido2midi

ifdef TOOL
	TOOLPATH := $(shell basename $(TOOL))
endif

nodlost	= "definitely lost: 0"
noilost	= "indirectly lost: 0"
noplost	= "possibly lost: 0"

gmnfiles     = $(shell find ../gmn-examples -name "*.gmn") $(wildcard ../regression-tests/*.gmn)
pdfout		:= $(patsubst ../%.gmn, $(version)/%.pdf, $(gmnfiles))
svgout		:= $(patsubst ../%.gmn, $(version)/%.svg, $(gmnfiles))
leaksout 	:= $(patsubst ../%.gmn, $(version)/$(TOOLPATH)/%.leaks.txt, $(gmnfiles))
midiout     := $(patsubst ../%.gmn, $(version)/%.mid, $(gmnfiles))

allpdf 		 = $(shell [ -d $(version) ] && find $(version) -name "*.pdf")
allsvg 		 = $(shell [ -d $(version) ] && find $(version) -name "*.svg")
leaksfiles  := $(patsubst ../%.gmn, $(version)/$(TOOLPATH)/%.leaks.out, $(gmnfiles))

validpdf 	= $(patsubst %.pdf, %.outpdf, $(allpdf))
validsvg 	= $(patsubst %.svg, %.outsvg, $(allsvg))

.PHONY: pdf svg

default : svg

pdfbased : pdf

help:
	@echo "Makefile for testing the engine output. Available targets are:"
	@echo "'svg' (default): makes svg files for a set of gmn files"
	@echo "                 the output folder name is the current guido engine version number."
	@echo "'pdf'          : makes pdf files for a set of gmn files"
	@echo "                 the output folder name is the current guido engine version number."
	@echo "'midi'         : makes MIDI files for a set of gmn files"
	@echo "                 the output folder name is the current guido engine version number."
	@echo "'validate VERSION=another_version': compares the current version pdf output with another one"
	@echo "'checkleaks TOOL=a_tool': check memory leaks on a set of gmn files using various tools"
	@echo "                 the basic tool set is included in this folder but any tool arbitrary tool could be used as well"
	@echo "'checkcrash TOOL=a_tool': run a tool with all the gmn files as arguments"

#########################################################################
# tools to validate the graphic output, based on pdf conversion
validate: $(validsvg)
	@$(eval tmp := $(shell [ -f $(version)/ignore.$(VERSION).txt ] && echo "using $(version)/ignore.$(VERSION).txt"))	
	@echo Validating version $(version) with $(VERSION) $(tmp)

pdfvalidate: $(validpdf)
	@$(eval tmp := $(shell [ -f $(version)/ignore.$(VERSION).txt ] && echo "using $(version)/ignore.$(VERSION).txt"))	
	@echo Validating version $(version) with $(VERSION) $(tmp)
	
%.outsvg: %.svg
	$(eval tmp := $(patsubst $(version)/%, $(VERSION)/%, $<))	
	@[ -f  $(tmp) ] || echo $< : new file
	$(eval ignored := $(shell grep $< $(version)/ignore.$(VERSION).txt 2>/dev/null || echo _none_))
	@[ -f  $(ignored) ] || diff $< $(tmp) 2>/dev/null >/dev/null || ([ -f  $(tmp) ] && echo "open -t $< $(patsubst $(version)/%, $(VERSION)/%, $<) # to check changes"; true)
	
%.outpdf: %.pdf
	$(eval tmp := $(patsubst $(version)/%, $(VERSION)/%, $<))	
	@[ -f  $(tmp) ] || echo $< : new file
	$(eval ignored := $(shell grep $< $(version)/ignore.$(VERSION).txt 2>/dev/null || echo _none_))
	@[ -f  $(ignored) ] || diff $< $(tmp) 2>/dev/null >/dev/null || ([ -f  $(tmp) ] && echo "open $< $(patsubst $(version)/%, $(VERSION)/%, $<) # to check changes"; true)

#########################################################################
# pdf output generation
pdf: forcepdfdate $(pdfout)
	@./forcepdfdate 20100101120000 $(pdfout)

pdfclean: 
	rm -f $(pdfout)

$(version)/%.pdf: ../%.gmn
	@[ -d $(@D) ] || mkdir -p $(@D)
	$(guido2image) -f $< -o $@

#########################################################################
# midi output generation
midi:  $(midiout)

midiclean: 
	rm -f $(midiout)

$(version)/%.mid: ../%.gmn
	@[ -d $(@D) ] || mkdir -p $(@D)
	-$(guido2midi) $< -o $@


#########################################################################
# leaks check tools
checkleaks: $(LEAKTOOLS) $(leaksout)
	make showleaks TOOL=$(TOOL)

showleaks: $(leaksfiles)

$(version)/$(TOOLPATH)/%.leaks.txt: ../%.gmn
	@[ -d $(@D) ] || mkdir -p $(@D)
	valgrind --leak-check=full --suppressions=valgrindignored.txt --log-file=$@ $(TOOL) $<

$(version)/$(TOOLPATH)/%.leaks.out: $(version)/$(TOOLPATH)/%.leaks.txt	
	@grep $(nodlost) $< > /dev/null || echo "$< : definitely lost bytes"
	@grep $(noilost) $< > /dev/null || echo "$< : indirectly lost bytes"
	@grep $(noplost) $< > /dev/null || echo "$< : possibly lost bytes"


#########################################################################
# crash tests
checkcrash: $(LEAKTOOLS)
	@$(TOOL) $(gmnfiles)


#########################################################################
# tools to generate svg files
svg: $(svgout)

svgclean: 
	rm -f $(svgout)

$(version)/%.svg: ../%.gmn
	@[ -d $(@D) ] || mkdir -p $(@D)
	-$(guido2svg) $< | grep -v "SVG file generated using" > __tmp.svg  &&  mv __tmp.svg $@


#########################################################################
# windows specific stuff
win32 : $(LEAKTOOLS)

GUIDOEngine.dll:
	cp ../cmake/release/GUIDOEngine.dll .

guidogetversion.exe:
	cp ../tools/cmake/release/guidogetversion.exe .

guido2svg.exe:
	cp ../tools/cmake/release/guido2svg.exe .

guidoparse.exe:
	cp ../tools/cmake/release/guidoparse.exe .

guidoar2gr.exe:
	cp ../tools/cmake/release/guidoar2gr.exe .

guidodraw.exe:
	cp ../tools/cmake/release/guidodraw.exe .

guido2image.exe:
	cp ../Qt/bin/guido2image.exe .

#########################################################################
# tools
tools: $(LEAKTOOLS)

cleantools:
	rm -f $(LEAKTOOLS)

guidodraw : guidodraw.cpp
	g++ guidodraw.cpp -I../src/include -I../src/tools $(lib) -o guidodraw

guidoar2gr : guidoar2gr.cpp
	g++ guidoar2gr.cpp -I../src/include -I../src/tools $(lib) -o guidoar2gr

guidoparse : guidoparse.cpp
	g++ guidoparse.cpp -I../src/include $(lib) -o guidoparse

forcepdfdate: forcepdfdate.cpp
	g++ forcepdfdate.cpp -o forcepdfdate

